
-- local example_json = [[
 -- [{"description":"the claws of Apsu - Lev(27) Loc(hands) AM AC AC-ap(6) AG AN nodrop no-auction hps(12) dr(4) Cond(pristine - 185 Days)","zone":"tomb","id":"1651","currentBid":null,"currentBidTime":null},{"description":"a scaly dragon's tail - Lev(26) Loc(waist) AC-ap(4) AG AN nodrop no-auction mana(31) hr(4) bluntvuln(-2) Cond(pristine - 185 Days)","zone":"tomb","currentBid":null,"id":"1652","currentBidTime":null},{"id":"1654","currentBid":null,"currentBidTime":null,"zone":"den","description":"a special silver sword - Lev(26) Loc(wield) AM AC 2H 6d10 AG AN hr(14) infspl(-2) SKL/SPL: disarm (success +11%) Cond(pristine - 185 Days)"},{"currentBid":null,"id":"1655","currentBidTime":null,"description":"the sword named Farslayer - Lev(30) Loc(throw) AM AC AT AW 2H 6d6  fragile hr(11) dr(4) Cond(pristine - 59 Days)","zone":"den"},{"id":"1659","currentBid":null,"currentBidTime":null,"description":"a sapphire bottle on an electrum chain - Lev(27) Loc(neck) AE hps(39) dr(-1) Cond(pristine - 185 Days)","zone":"den"},{"zone":"den","description":"blackened chainmail of the necromancer - Lev(28) Loc(body) AC AT AW AC-ap(8) AG AN hps(9) mana(20) Cond(pristine - 185 Days)","currentBidTime":null,"id":"1663","currentBid":null},{"id":"1664","currentBid":null,"currentBidTime":null,"zone":"den","description":"Neifirst's sword - Lev(26) Loc(wield) AM AC 2H 7d9 NoBits mana(-27) hr(6) SKL/SPL: bash (success +8%) parry (success +6%) disarm (susceptibility +6%) Cond(pristine - 185 Days)"},{"id":"1666","currentBid":null,"currentBidTime":null,"zone":"undeadforest","description":"the illumination of the holy church - Lev(29) Loc(head) AE AW AM AT fragile hps(30) ss(0) Cond(pristine - 185 Days)"},{"description":"the Helmet of Holy Embrace - Lev(22) Loc(head) AM AT AC-ap(6) AE AN hps(20) mana(18) Cond(pristine - 185 Days)","zone":"undeadforest","id":"1667","currentBid":null,"currentBidTime":null},{"zone":"undeadforest","description":"the Time-Honored Shield of Impending Silence - Lev(26) Loc(shield) AM AC AT AC-ap(14) AE ss(-1) hps(24) SKL/SPL: Harm (susceptibility -10%) Heal (manacost +6%) Cond(pristine - 185 Days)","currentBidTime":null,"id":"1668","currentBid":null},{"description":"a heavily armored dragonscale breastplate - Lev(24) Loc(body) AM AC AT AC-ap(8) AG AE sbr(-2) hps(18) Cond(pristine - 185 Days)","zone":"undeadforest","id":"1671","currentBid":null,"currentBidTime":null},{"description":"a vaporous tentacle - Lev(25) Loc(about) AG AN hps(32) hps(-9) Cond(pristine - 185 Days)","zone":"den","currentBidTime":null,"id":"1672","currentBid":null},{"currentBid":null,"id":"1674","currentBidTime":null,"zone":"den","description":"adamantite plates of the warlord - Lev(26) Loc(arms) AM AC AC-ap(9) AG AN dr(4) hps(9) SKL/SPL: bash (success +6%) archery (proficiency success -6%) Cond(pristine - 185 Days)"},{"currentBid":null,"id":"1676","currentBidTime":null,"description":"a sapphire bottle on an electrum chain - Lev(27) Loc(neck) AE hps(41) dr(-1) Cond(pristine - 185 Days)","zone":"den"},{"currentBidTime":null,"id":"1678","currentBid":null,"zone":"den","description":"the sword named Farslayer - Lev(29) Loc(throw) AM AC AT AW 2H 6d6  fragile hr(13) dr(5) Cond(pristine - 59 Days)"},{"zone":"den","description":"the robe of the necromancer - Lev(23) Loc(about) AG AN mana(47) holyvuln(5) SKL/SPL: Frost Shards (proficiency +9%) Chill Touch (proficiency manacost +6%) Heal (proficiency -4%) Cond(pristine - 185 Days)","currentBidTime":null,"currentBid":null,"id":"1680"},{"description":"blackened chainmail of the necromancer - Type(Armor) Lev(26) AC-ap(8) Loc(body) hps(19) mana(19) [AC AT AW] [EVIL INV CURSED AG AN] Cond(pristine-185)","zone":"den","currentBidTime":null,"id":"1681","currentBid":null},{"zone":"den","description":"laconite claws - Lev(28) Loc(hands) AC-ap(1) AG AN dr(4) hps(-4) SKL/SPL: disarm (susceptibility success -8%) Cond(pristine - 185 Days)","currentBid":null,"id":"1683","currentBidTime":null},{"description":"a pair of ethereal shackles - Lev(25) Loc(wrist) AT AC-ap(12)  MS hr(6) dr(6) Cond(pristine - 185 Days)","zone":"condemned","currentBid":null,"id":"1684","currentBidTime":null},{"description":"a feather shroud - Lev(19) Loc(about) NoBits hps(24) sbr(-2) Cond(pristine - 185 Days) ","zone":"condemned","currentBid":null,"id":"1685","currentBidTime":null},{"currentBidTime":null,"currentBid":null,"id":"1686","description":"a dragon claw necklace - Lev(20) Loc(neck) NoBits hr(4) dr(2) Cond(pristine - 185 Days) ","zone":"condemned"},{"zone":"condemned","description":"a dragon scale belt - Lev(20) Loc(waist) AC-ap(2) NoBits hps(23) sbr(-2) Cond(pristine - 185 Days) ","currentBidTime":null,"currentBid":null,"id":"1687"},{"id":"1688","currentBid":null,"currentBidTime":null,"zone":"condemned","description":"an orcish warhelm - Lev(19) Loc(head) AM AC-ap(8) NoBits hps(22) hr(3) Cond(pristine - 185 Days) "},{"currentBid":null,"id":"1690","currentBidTime":null,"zone":"condemned","description":"a bracelet of gladiators - Lev(20) Loc(wrist) AC-ap(2) NoBits hps(19) Cond(pristine - 185 Days) "},{"currentBidTime":null,"currentBid":null,"id":"1691","zone":"condemned","description":"a dark mantle - Lev(23) Loc(about) AG hr(5) mana(33) Cond(pristine - 185 Days) "},{"currentBidTime":null,"currentBid":null,"id":"1693","zone":"condemned","description":"a rune-covered crimson jerkin - Lev(25) Loc(body) AC-ap(4) NoBits hr(6) dr(-2) Cond(pristine - 185 Days) "},{"zone":"condemned","description":"demon claws - Lev(24) Loc(hands) AC-ap(8) AG dr(4) hr(1) Cond(pristine - 185 Days) ","currentBidTime":null,"currentBid":null,"id":"1694"},{"currentBidTime":null,"id":"1695","currentBid":null,"zone":"condemned","description":"the hooves of a demon - Lev(25) Loc(feet) AC-ap(10) AG hr(8) dex(-1) Cond(pristine - 185 Days) "},{"zone":"condemned","description":"the glowing eyes of a demon - Lev(27) Loc(light) AG hr(4) ss(0) Cond(pristine - 185 Days) ","currentBidTime":null,"id":"1696","currentBid":null},{"zone":"condemned","description":"a one-horned skull - Lev(30) Loc(head) AM AC AC-ap(8) AG mana(-48) dr(6) Cond(pristine - 185 Days)","currentBidTime":null,"currentBid":null,"id":"1700"},{"description":"the golden leggings of Eldrick - Lev(27) Loc(legs) AM AC AC-ap(5) AE AN dr(3) mana(30) Cond(pristine - 185 Days)","zone":"eldricks","id":"1701","currentBid":null,"currentBidTime":null},{"description":"Cecilia's cloak - Lev(23) Loc(about) AE AN ss(-2) mana(37) Cond(pristine - 185 Days)","zone":"eldricks","currentBidTime":null,"currentBid":null,"id":"1702"},{"currentBidTime":null,"id":"1704","currentBid":null,"description":"the golden sword of Eldrick - Lev(27) Loc(wield) AM AC AT 8d7 AE AN holy hr(4) dr(2) SKL/SPL: parry (success +5%) Cond(pristine - 185 Days)","zone":"eldricks"},{"currentBidTime":null,"currentBid":null,"id":"1705","description":"the golden armor of Eldrick - Lev(26) Loc(body) AM AC AT AC-ap(8) AE AN hps(36) hr(3) Cond(pristine - 185 Days)","zone":"eldricks"},{"id":"1706","currentBid":null,"currentBidTime":null,"zone":"eldricks","description":"the golden signet ring of Eldrick - Lev(28) Loc(fing) AM AC  AE AN dr(5) ss(0) Cond(pristine - 185 Days)"},{"description":"a red lover's bracelet with the name 'Eldrick' engraved on it - Lev(26) Loc(wrist) AM AC AT AC-ap(6) AE AN hr(3) hps(26) Cond(pristine - 185 Days)","zone":"eldricks","currentBid":null,"id":"1707","currentBidTime":null},{"description":"a collar with the word \"Cecilia\" etched on it - Lev(23) Loc(neck) AM AC AW  AN dr(5) Cond(pristine - 185 Days)","zone":"eldricks","currentBidTime":null,"id":"1708","currentBid":null},{"id":"1709","currentBid":null,"currentBidTime":null,"zone":"eldricks","description":"a sapphire dagger - Lev(26) Loc(wield) AM AC DAG BSER 6d6 AE AN hr(4) dr(0) Cond(pristine - 185 Days)"},{"currentBidTime":null,"id":"1710","currentBid":null,"zone":"eldricks","description":"a war horn - Lev(23) Loc(hold) AE dr(3) hr(3) Cond(pristine - 185 Days)"},{"currentBidTime":null,"id":"1711","currentBid":null,"zone":"tomb","description":"a prismatic band, bound with the four elements - Lev(26) Loc(wrist) AE AN hr(3) dr(3) Cond(pristine - 185 Days)"},{"description":"the belt of the illusionist - Lev(30) Loc(waist) AC AT AW  AG AE nodrop no-auction hps(12) mana(30) infcle(-2) SKL/SPL: Colour Spray (proficiency +11%) Fear (proficiency +8%) Cond(pristine - 185 Days)","zone":"tomb","currentBidTime":null,"id":"1712","currentBid":null},{"zone":"tomb","description":"an ancient death mask - Lev(29) Loc(head) AM AC AT AC-ap(8) AG AN nodrop no-auction dr(4) srod(-1) ss(-1) Cond(pristine - 185 Days)","currentBidTime":null,"id":"1713","currentBid":null},{"currentBidTime":null,"id":"1714","currentBid":null,"description":"a deep red stone - Lev(0) Loc(hold)  nodrop no-auction dex(2) Cond(pristine - 185 Days)","zone":"tomb"},{"currentBidTime":null,"id":"1715","currentBid":null,"description":"the flames of destruction, bound into a circle - Lev(25) Loc(fing) AG AN AW AT nodrop no-auction mana(20) hps(20) Cond(pristine - 185 Days)","zone":"tomb"},{"currentBid":null,"id":"1716","currentBidTime":null,"zone":"tomb","description":"a burning mantle - Lev(28) Loc(about) AT AW  AG AN nodrop no-auction mana(21) hps(22) coldvuln(2) firevuln(-3) SKL/SPL: Demonfire (efficiency +9%) Fireball (efficiency +6%) Cond(pristine - 185 Days)"},{"description":"boots carved from pure basalt - Lev(26) Loc(feet) AM AT AW AC-ap(6) AG AN mana(3) hps(32) SKL/SPL: Demonfire (proficiency +6%) Harm (proficiency manacost +2%) Heal (manacost +15%) Cond(pristine - 185 Days)","zone":"tomb","currentBidTime":null,"currentBid":null,"id":"1718"},{"zone":"tomb","description":"a delicate crystal crown - Lev(30) Loc(head) AM AT AW AC-ap(5) AE nodrop no-auction hps(30) srod(-2) SKL/SPL: Phantasmal Images (manacost -19%) Phantasmal Images (efficiency +9%) Cond(pristine - 185 Days)","currentBidTime":null,"id":"1719","currentBid":null},{"currentBid":null,"id":"1720","currentBidTime":null,"zone":"tomb","description":"the staff of wisdom - Lev(30) Loc(wield) AT AW 2H LNG 6d7 AE AN nodrop no-auction hps(13) mana(77) infmel(-4) SKL/SPL: Shockwave (efficiency +8%) Shockwave (success +28%) Cond(pristine - 185 Days)"},{"id":"1721","currentBid":null,"currentBidTime":null,"description":"the gloves of Destiny - Lev(24) Loc(hands) AC-ap(5) AE AN nodrop hps(5) dr(4) SKL/SPL: disarm (susceptibility -12%) Cond(pristine - 185 Days)","zone":"tomb"},{"currentBid":null,"id":"1722","currentBidTime":null,"zone":"tomb","description":"a ring of quicksilver - Lev(26) Loc(fing) AM AC  AG AE hr(3) dr(1) infmel(1) SKL/SPL: dodge (success +4%) Cond(pristine - 185 Days)"},{"description":"a handful of iridescent sand - Lev(0) Loc(hold) AM AT   nodrop no-auction Cond(pristine - 185 Days)","zone":"tomb","currentBidTime":null,"currentBid":null,"id":"1723"},{"currentBidTime":null,"currentBid":null,"id":"1724","description":"Aehhyrshahl, scimitar of the Four Winds - Lev(26) Loc(wield) AM AC DAG BSER 7d5 AE nodrop no-auction hr(3) dr(3) SKL/SPL: Hands of Wind (success +41%) Hands of Wind (manacost -18%) Cond(pristine - 185 Days)","zone":"tomb"},{"currentBidTime":null,"currentBid":null,"id":"1725","description":"flowstone leg guards - Lev(26) Loc(legs) AM AC-ap(10) AE nodrop no-auction dr(3) hr(1) infmel(1) Cond(pristine - 185 Days)","zone":"tomb"},{"zone":"tomb","description":"a jet black skirt, immolated in Darkfire - Lev(24) Loc(legs) AT AW AC-ap(10) AG AN nodrop no-auction hps(26) mana(31) srod(1) Cond(pristine - 185 Days)","currentBid":null,"id":"1726","currentBidTime":null},{"zone":"den","description":"the ring of Red Ruin - Lev(28) Loc(fing) AG AN AM AC hr(2) dr(2) Cond(pristine - 185 Days)","id":"1677","currentBid":"1","currentBidTime":"2014-10-18 20:06:15"},{"zone":"den","description":"the ruby of Destruction - Lev(28) Loc(hold) NoBits dr(8) hps(-76) infmel(2) infspl(-5) Cond(pristine - 185 Days)","currentBid":"1","id":"1679","currentBidTime":"2014-10-18 20:06:34"},{"currentBidTime":"2014-10-18 22:35:38","currentBid":"1","id":"1675","zone":"den","description":"an amulet of haste - Lev(24) Loc(neck) NoBits hr(10) Cond(pristine - 185 Days)"},{"zone":"den","description":"Wraithedge, the dagger of shadows - Lev(25) Loc(wield) AM AC AW BSER 6d6 AG cold hr(5) dr(3) SKL/SPL: ambush (proficiency +10%) parry (success -6%) Cond(pristine - 185 Days)","currentBid":"3","id":"1682","currentBidTime":"2014-10-18 22:41:40"},{"currentBid":"50","id":"1673","currentBidTime":"2014-10-18 22:41:51","zone":"den","description":"a ring of charred brimstone - Lev(20) Loc(fing) AM AC AW  AG noegg hr(4) dr(3) Cond(pristine - 185 Days)"},{"zone":"undeadforest","description":"a flaming stiletto, burning with magical fire - Lev(27) Loc(wield) AM AC DAG BSER 6d6 AG AN nodrop fire no-auction dr(6) ss(-1) Cond(pristine - 185 Days)","id":"1670","currentBid":"3","currentBidTime":"2014-10-18 22:43:13"},{"zone":"undeadforest","description":"a gold timepiece on a wristband - Lev(22) Loc(hold) 1xQuickness -   nodrop no-auction Cond(pristine - 185 Days)","currentBidTime":"2014-10-18 22:43:28","id":"1669","currentBid":"1"},{"zone":"condemned","description":"a runed ivory blade - Lev(24) Loc(wield) AC DAG BSER 6d6 AG hr(5) mana(56) Cond(pristine - 185 Days) ","currentBid":"1","id":"1692","currentBidTime":"2014-10-19 09:17:16"},{"description":"a steel-plated leather skirt - Lev(21) Loc(legs) AM AC AC-ap(10) NoBits hr(4) dr(2) Cond(pristine - 185 Days) ","zone":"condemned","currentBidTime":"2014-10-19 09:17:34","id":"1689","currentBid":"1"},{"description":"the dagger of Faerie Fire - Lev(3) Loc(wield) DAG BSER 5d3 NoBits hr(5) dr(2) Cond(pristine - 185 Days) ","zone":"condemned","currentBidTime":"2014-10-19 09:17:48","currentBid":"1","id":"1698"},{"currentBidTime":"2014-10-19 13:15:09","id":"1703","currentBid":"1","description":"the gloves of divination - Lev(28) Loc(hands) AT AW  AE AN mana(36) ss(-2) Cond(pristine - 185 Days)","zone":"eldricks"},{"description":"a pink rod - Lev(0) Loc(hold) 30xFaerie Fire -  NoBits hr(3) Cond(pristine - 44.82 Days) ","zone":"condemned","currentBid":"1","id":"1697","currentBidTime":"2014-10-19 14:54:59"},{"zone":"tomb","description":"several silver dragon scales - Lev(0) Loc(None)  nodrop  no-auction Cond(pristine - 185 Days)","id":"1650","currentBid":"1320","currentBidTime":"2014-10-19 17:03:09"},{"currentBid":"1","id":"1699","currentBidTime":"2014-10-19 17:40:29","description":"a demon's ribcage - Lev(26) Loc(body) AM AC AC-ap(5) AG dr(4) hps(-26) Cond(pristine - 185 Days) ","zone":"condemned"},{"description":"the Essence of Fire - Lev(0) Loc(None)  nodrop no-auction Cond(pristine - 185 Days)","zone":"tomb","currentBidTime":"2014-10-20 01:11:43","id":"1717","currentBid":"1"}]
-- ]]

local ev = require( "ev" )
local loop = ev.Loop.default

-- Warning, a value of "null" in json must be checked as follows:
--   if value == json.null # value is null
-- See http://www.kyne.com.au/~mark/software/lua-cjson-manual.html#_null
local json = require("cjson")

local globalEqCache = {}
local globalLastUpdate = nil

-- return a string to send to clients for the passed updates in eqFeedJson, given the current state in passed eqCache
local function updateEqCache( eqCache, eqFeedJson )
  local msg = {}

  local eqFeed = json.decode(eqFeedJson)

  for _, item in ipairs(eqFeed) do
    if eqCache[item["id"]] == nil then
      -- new item, add it to cache
      eqCache[item["id"]] = item
      table.insert(msg, string.format("#ly%12s #lg-   #lcnew #lg- #w%s", item["zone"], item["description"]))
    else
      -- TODO - picked items!!!
      if eqCache[item["id"]]["currentBid"] ~= item["currentBid"] then
        -- upbid on existing item
        table.insert(msg, string.format("#ly%12s #lg- #lc%5s #lg- #w%s", item["zone"], item["currentBid"], item["description"]))
        eqCache[item["id"]] = item
      end
    end
  end
  if next(msg) ~= nil then
    table.insert(msg, 1, "#lwUPS Activity\n")
    return table.concat( msg, "\n")
  else
    return ""
  end
end

local function renderEqCache( eqCache )
  local msg = {}

  -- TODO - would be nice to have eq sorted by currentBidTime
  -- TODO - most of this output is cut off due to max socket:send length. Output isn't buffered.
  for id, item in pairs(eqCache) do
    if item["currentBid"] == json.null then
      table.insert(msg, string.format("#ly%12s #lg-       #lg- #w%s", item["zone"], item["description"]))
    else
      table.insert(msg, string.format("#ly%12s #lg- #lc%5s #lg- #w%s", item["zone"], item["currentBid"], item["description"]))
    end
  end
  if next(msg) ~= nil then
    table.insert(msg, 1, "#lw        zone     bid   item\n------------------------------")
    table.insert(msg, 1, "#lwUPS Recent Eq\n")
    return table.concat( msg, "\n")
  else
    return ""
  end
end

-- Synchronously run the passed console cmd and return its stdout
function capture(cmd)
  local f = assert(io.popen(cmd, 'r'))
  local s = assert(f:read('*a'))
  f:close()
  return s
end

local function cmdUps(client, eqCache)
  client:msg( "%s", renderEqCache(eqCache))
end

chat.command( "ups", "user", function(client)
  cmdUps(client, globalEqCache)
end, "Show recent UPS eq")

local function blockingGetEqFeed()
  globalLastUpdate = updateEqCache(globalEqCache, capture("curl -m2 localhost/cgi-bin/eq_feed.pl 2> /dev/null"))
  if globalLastUpdate ~= '' then
    chat.msg( "%s", globalLastUpdate)
  end
end

ev.Timer.new( blockingGetEqFeed, 1, 60):start( loop )
